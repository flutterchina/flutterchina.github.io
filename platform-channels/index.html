<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>使用平台通道编写平台特定的代码  - Flutter中文网 </title>
  <link rel="shortcut icon" href="/images/favicon.png">
  <meta name="description" content="本文介绍在Flutter中如何与原生系统通信、调用彼此的接口，并同时介绍了Flutter的插件系统。">
  <meta name="keywords" content="Flutter插件,flutter中文网, flutter教程, Flutter中文网, flutter文档 ">
  <meta name="baidu-site-verification" content="oeLolPaTVU" />
  <meta name="sogou_site_verification" content="xhNTjenszq"/>
  <meta name="baidu_union_verify" content="d98c3b5eb9879153e86969574c39ced9">
  <link rel="stylesheet" href="/css/lavish-bootstrap.css">
  <link rel="stylesheet" href="/css/main.css">
  <link href="https://cdn.jsdelivr.net/gh/google/material-design-icons@3.0.1/iconfont/material-icons.css" rel="stylesheet">
  <!--<link href="https://fonts.googleapis.com/css?family=Source+Code+Pro%7CRoboto:500,400italic,300,400" rel="stylesheet">-->
  
  <link rel="canonical" href="https://www.flutterchina.club/platform-channels/">

  <!-- 与 wendux 达成一致，跳转本页面到最新文档，感谢！ -->
  <meta http-equiv="refresh" content="0; url='https://flutter.cn/docs/development/platform-integration/platform-channels'">
  <!-- flutterchina.club/platform-channels/ -> flutter.cn/platform-channels/ -->

  <script>
    function onSubmit() {
        open("http://zhannei.baidu.com/cse/site?cc=flutterchina.club&q=" + $("input[name=q]").val(), "_blank");
        return false;
    }
  </script>
  
  <meta name="google-site-verification" content="HFqxhSbf9YA_0rBglNLzDiWnrHiK_w4cqDh2YD2GEY4" />
</head>


<body >

<div id="overlay-under-drawer"><!-- for the drawer on narrow screens --></div>

<header class="site-header">
  <div class="container-fluid header-contents">
    <div class="row">
      <div class="col-md-12">
        <!--<i class="fa fa-bars" id="sidebar-toggle-button" aria-hidden="true" style="display:none"></i>-->
        <i class="material-icons" id="sidebar-toggle-button" aria-hidden="true" style="display:none; margin-left: -10px">menu</i>
        <img src= "/images/flutter-mark-square-100.png" alt="Flutter Logo" width="40" height="40" style="vertical-align:middle">
        <a class="site-title" href="/">Flutter中文网</a>

        <nav class="site-nav">
          <a href="#" class="menu-icon" style="margin-right: -15px">
            <i class="material-icons">more_vert</i>
          </a>
          <div class="trigger">
            <a class="page-link" href="/docs/">文档</a>
            <a class="page-link" href="/opensource.html">开源项目</a>
            <a class="page-link" href="https://book.flutterchina.club" style="color:blue">《Flutter实战》 <sup style="font-size: 13px; color: red"> 新书</sup></a>
            <form class="nav-searchbox" style="display: inline-block"   onsubmit='return onSubmit()' >
              <input type="search"  name="q"  autocomplete="off" placeholder="搜索">
              <input type="hidden" name="cc" value="flutterchina.club">
            </form>
          </div>
        </nav>
      </div>
    </div> <!-- /.row -->
  </div> <!-- /.container -->
</header>


<!-- Page Content -->
<div class="container-fluid contents">
    <!-- Content Row -->
    <div class="row">

        <!-- Sidebar Column -->
        <div id="side-nav-container" class="col-sm-3">
            <ul id="mysidebar" class="nav">

  <li class="sidebar-title">起步</li>

    <ul class="sidebar-items">
      <li><a href="/get-started/install/">1: 安装</a></li>
      <li><a href="/get-started/editor/">2: 配置编辑器</a></li>
      <li><a href="/get-started/test-drive/">3: 体验Flutter </a></li>
      <li><a href="/get-started/codelab/">4: 编写第一个Flutter应用</a></li>
      <li><a href="/get-started/learn-more/">5: 了解更多</a></li>
    </ul>

  <li class="sidebar-title">构建用户界面</li>

    <ul class="sidebar-items">
      <li><a href="/widgets-intro/">Widget 框架总览</a></li>
      <li><a href="/widgets/">Widget 目录</a></li>
      <li><a href="/cookbook/">Cookbook</a></li>
      <li><a href="/catalog/samples/">示例目录</a></li>
      <li><a href="/tutorials/layout/">构建布局 - 教程</a></li>
      <li><a href="/tutorials/interactive/">添加交互- 教程</a></li>
      <li><a href="/web-analogs/">Flutter for Web开发者</a></li>
      <li><a href="/flutter-for-android/">Flutter for Android 开发者</a></li>
      <li><a href="/flutter-for-ios/">Flutter for iOS 开发者</a></li>
      <li><a href="/flutter-for-react-native/">Flutter for React Native 开发者</a></li>
      <!--<li><a href="/flutter-for-react-native/">Flutter for React Native 开发者</a></li>-->
      <li><a href="/gestures/">手势</a></li>
      <li><a href="/animations/">动画</a></li>
      <li><a href="/custom-fonts/">自定义字体</a></li>
      <li><a href="/layout/">盒约束</a></li>
      <li><a href="/assets-and-images/">资源和图片</a></li>
      <li><a href="/text-input/">文本输入</a></li>
      <li><a href="/routing-and-navigation/">路由和导航</a></li>
      <li><a href="/tutorials/internationalization">国际化（多语言支持）</a></li>
    </ul>

  <li class="sidebar-title">使用设备和SDK API</li>

    <ul class="sidebar-items">
      <li><a href="/using-packages/">使用packages</a></li>
      <li><a href="/developing-packages/">开发packages</a></li>
      <li><a href="/platform-channels/">平台特定的代码</a></li>
      <li><a href="/reading-writing-files/">文件读写</a></li>
      <li><a href="/networking/">网络和Http</a></li>
      <li><a href="/json/">JSON和序列化</a></li>
    </ul>

  <li class="sidebar-title">开发和工具</li>

    <ul class="sidebar-items">
      <li><a href="/using-ide/">使用Flutter IDE</a></li>
      <li><a href="/hot-reload/">使用热重载</a></li>
      <li><a href="/testing/">测试应用</a></li>
      <li><a href="/debugging/">调试应用</a></li>
      <li><a href="/inspector/">检查(Inspect)用户界面</a></li>
      <li><a href="/android-release/">Android构建发布</a></li>
      <li><a href="/ios-release/">IOS构建发布</a></li>
      <li><a href="/upgrading/">升级安装的Flutter</a></li>
      <li><a href="/formatting/">格式化代码</a></li>
    </ul>

  <li class="sidebar-title">更多细节</li>

    <ul class="sidebar-items">
      <li><a href="/faq/">FAQ</a></li>
      <li><a href="/technical-overview">Flutter框架总览</a></li>
    </ul>
  <li class="sidebar-title">站外内容 <sup style="font-size: 13px; color: #000"> 需翻墙</sup></li>
    <ul class="sidebar-items">
        <li><a href="https://codelabs.developers.google.com/codelabs/flutter/index.html#0">构建漂亮的用户界面 - Codelab</a></li>
        <li><a href="https://docs.google.com/presentation/d/1B3p0kP6NV_XMOimRV09Ms75ymIjU5gr6GGIX74Om_DE/edit?usp=sharing">Flutter滑动的魔法</a></li>
        <li><a href="https://docs.google.com/presentation/d/1cw7A4HbvM_Abv320rVgPVGiUP2msVs7tfGbkgdrTy0I/edit?usp=sharing">架构图</a></li>
        <li><a href="https://www.youtube.com/watch?v=dkyY9WCGMi0">框架的分层设计<i class="fa fa-video-camera" aria-hidden="true"></i></a></li>
        <li><a href="https://www.youtube.com/watch?v=UUfXWzp0-DU">Flutter的渲染管道 <i class="fa fa-video-camera" aria-hidden="true"></i></a></li>
    </ul>


</ul>

        </div>

        
        

        <!-- Content Column -->
        
            <div class="col-sm-8  main-contents">
                

                <div class="main-contents-body">
                    <!--<div style="padding: 16px 10px; background:#4097de; border-radius: 3px; margin-bottom: 50px;">-->
                    <!--<div id="download-padding" style="background: url(/images/gitme/180.png) no-repeat; background-size: contain; color:#fff; ">-->
                        <!--<a href="/app/gm.html" style="color: #fff">Gitme是用flutter开发的一款github客户端，敬请体验。</a>-->
                        <!--<a id="download" href="/app/gm.html">去了解</a>-->
                     <!--</div>-->
                    <!--</div>-->
                    <article class="post-content">

  
  <header class="post-header">
      <div class="btn-group contribute" role="group">
         <a href="https://github.com/flutterchina/website/blob/master/platform-channels.md" class="btn btn-sm">
            <i class="fa fa-pencil"></i> 编辑本页
         </a>
         <a href="https://github.com/flutter/flutter/issues/new?title=Issue from website page 使用平台通道编写平台特定的代码&body=From URL: https://www.flutterchina.club/platform-channels.md&labels=dev: docs - website" class="btn btn-sm">
            <i class="fa fa-github"></i> 提Issue
        </a>
     </div>
   <div>
    <h1 class="post-title">使用平台通道编写平台特定的代码 </h1>
   </div>

  </header>
  

  <blockquote>
  <p>译者语：所谓“平台特定”或“特定平台”，平台指的就是原生Android或IOS，本文主要讲原生和Flutter之间如何通信、如何进行功能互调。</p>
</blockquote>

<p>本指南介绍如何编写自定义平台特定的代码。一些平台特定的功能可通过现有软件包获得; 请参阅<a href="/using-packages/">使用 packages</a>。</p>

<ul id="markdown-toc">
  <li><a href="#architecture" id="markdown-toc-architecture">框架概述: 平台通道</a>    <ul>
      <li><a href="#codec" id="markdown-toc-codec">平台通道数据类型支持和解码器</a></li>
    </ul>
  </li>
  <li><a href="#example" id="markdown-toc-example">示例: 使用平台通道调用iOS和Android代码</a>    <ul>
      <li><a href="#example-project" id="markdown-toc-example-project">Step 1: 创建一个新的应用程序项目</a></li>
      <li><a href="#example-client" id="markdown-toc-example-client">Step 2: 创建Flutter平台客户端</a></li>
      <li><a href="#example-java" id="markdown-toc-example-java">Step 3a: 使用Java添加Android平台特定的实现</a></li>
      <li><a href="#example-kotlin" id="markdown-toc-example-kotlin">Step 3b: 使用Kotlin添加Android平台特定的实现</a></li>
      <li><a href="#example-objc" id="markdown-toc-example-objc">Step 4a: 使用Objective-C添加iOS平台特定的实现</a></li>
      <li><a href="#example-swift" id="markdown-toc-example-swift">Step 4b: 使用Swift添加一个iOS平台的实现</a></li>
    </ul>
  </li>
  <li><a href="#separate" id="markdown-toc-separate">从UI代码中分离平台特定的代码</a></li>
  <li><a href="#publish" id="markdown-toc-publish">将平台特定的代码作为一个包发布</a></li>
  <li><a href="#自定义平台通道和编解码器" id="markdown-toc-自定义平台通道和编解码器">自定义平台通道和编解码器</a></li>
</ul>

<p>Flutter使用了一个灵活的系统，允许您调用特定平台的API，无论在Android上的Java或Kotlin代码中，还是iOS上的ObjectiveC或Swift代码中均可用。</p>

<p>Flutter平台特定的API支持不依赖于代码生成，而是依赖于灵活的消息传递的方式：</p>

<ul>
  <li>
    <p>应用的Flutter部分通过平台通道（platform channel）将消息发送到其应用程序的所在的宿主（iOS或Android）。</p>
  </li>
  <li>
    <p>宿主监听的平台通道，并接收该消息。然后它会调用特定于该平台的API（使用原生编程语言） - 并将响应发送回客户端，即应用程序的Flutter部分。</p>
  </li>
</ul>

<h2 id="architecture">框架概述: 平台通道</h2>

<p>使用平台通道在客户端（Flutter UI）和宿主（平台）之间传递消息，如下图所示：</p>

<p><img src="/images/PlatformChannels.png" alt="Platform channels architecture" /></p>

<p>消息和响应是异步传递的，以确保用户界面保持响应(不会挂起)。</p>

<p>在客户端，<code class="highlighter-rouge">MethodChannel</code> (<a href="https://docs.flutter.io/flutter/services/MethodChannel-class.html">API</a>)可以发送与方法调用相对应的消息。
在宿主平台上，<code class="highlighter-rouge">MethodChannel</code> 在Android（(<a href="https://docs.flutter.io/javadoc/io/flutter/plugin/common/MethodChannel.html">API</a>) 和 FlutterMethodChannel iOS (<a href="https://docs.flutter.io/objcdoc/Classes/FlutterMethodChannel.html">API</a>)
可以接收方法调用并返回结果。这些类允许您用很少的“脚手架”代码开发平台插件。</p>

<div class="alert alert-info">
  <p><strong>注意</strong>: 如果需要，方法调用也可以反向发送，宿主作为客户端调用Dart中实现的API。
这个<a href="https://pub.dartlang.org/packages/quick_actions"><code class="highlighter-rouge">quick_actions</code></a>插件就是一个具体的例子</p>
</div>

<h3 id="codec">平台通道数据类型支持和解码器</h3>

<p>标准平台通道使用标准消息编解码器，以支持简单的类似JSON值的高效二进制序列化，例如
booleans,numbers, Strings, byte buffers, List, Maps（请参阅<a href="https://docs.flutter.io/flutter/services/StandardMessageCodec-class.html"><code class="highlighter-rouge">StandardMessageCodec</code></a>了解详细信息）。
当您发送和接收值时，这些值在消息中的序列化和反序列化会自动进行。</p>

<p>下表显示了如何在宿主上接收Dart值，反之亦然：</p>

<table>
  <thead>
    <tr>
      <th>Dart</th>
      <th>Android</th>
      <th>iOS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>null</td>
      <td>null</td>
      <td>nil (NSNull when nested)</td>
    </tr>
    <tr>
      <td>bool</td>
      <td>java.lang.Boolean</td>
      <td>NSNumber numberWithBool:</td>
    </tr>
    <tr>
      <td>int</td>
      <td>java.lang.Integer</td>
      <td>NSNumber numberWithInt:</td>
    </tr>
    <tr>
      <td>int, if 32 bits not enough</td>
      <td>java.lang.Long</td>
      <td>NSNumber numberWithLong:</td>
    </tr>
    <tr>
      <td>int, if 64 bits not enough</td>
      <td>java.math.BigInteger</td>
      <td>FlutterStandardBigInteger</td>
    </tr>
    <tr>
      <td>double</td>
      <td>java.lang.Double</td>
      <td>NSNumber numberWithDouble:</td>
    </tr>
    <tr>
      <td>String</td>
      <td>java.lang.String</td>
      <td>NSString</td>
    </tr>
    <tr>
      <td>Uint8List</td>
      <td>byte[]</td>
      <td>FlutterStandardTypedData typedDataWithBytes:</td>
    </tr>
    <tr>
      <td>Int32List</td>
      <td>int[]</td>
      <td>FlutterStandardTypedData typedDataWithInt32:</td>
    </tr>
    <tr>
      <td>Int64List</td>
      <td>long[]</td>
      <td>FlutterStandardTypedData typedDataWithInt64:</td>
    </tr>
    <tr>
      <td>Float64List</td>
      <td>double[]</td>
      <td>FlutterStandardTypedData typedDataWithFloat64:</td>
    </tr>
    <tr>
      <td>List</td>
      <td>java.util.ArrayList</td>
      <td>NSArray</td>
    </tr>
    <tr>
      <td>Map</td>
      <td>java.util.HashMap</td>
      <td>NSDictionary</td>
    </tr>
  </tbody>
</table>

<p><br /></p>
<h2 id="example">示例: 使用平台通道调用iOS和Android代码</h2>

<p>以下演示如何调用平台特定的API来获取和显示当前的电池电量。它通过一个平台消息<code class="highlighter-rouge">getBatteryLevel</code> 调用Android <code class="highlighter-rouge">BatteryManager</code> API和iOS <code class="highlighter-rouge">device.batteryLevel</code> API。  。</p>

<p>该示例在应用程序内添加了特定于平台的代码。如果您想开发一个通用的平台包，可以在其它应用中也使用的话，你需要开发一个插件，
则项目创建步骤稍有不同（请参阅<a href="/developing-packages/#plugin">开发 packages</a>），但平台通道代码仍以相同方式编写。</p>

<div class="alert alert-info">
  <p><strong>注意</strong>: 此示例的完整的可运行源代码位于：<a href="https://github.com/flutter/flutter/tree/master/examples/platform_channel"><code class="highlighter-rouge">/examples/platform_channel/</code></a>，
这个示例Android是用的Java, IOS用的是Objective-C，IOS Swift版本请参阅 <a href="https://github.com/flutter/flutter/tree/master/examples/platform_channel_swift"><code class="highlighter-rouge">/examples/platform_channel_swift/</code></a></p>
</div>

<h3 id="example-project">Step 1: 创建一个新的应用程序项目</h3>

<p>首先创建一个新的应用程序:</p>

<ul>
  <li>在终端运行中：<code class="highlighter-rouge">flutter create batterylevel</code></li>
</ul>

<p>默认情况下，模板支持使用Java编写Android代码，或使用Objective-C编写iOS代码。要使用Kotlin或Swift，请使用-i和/或-a标志:</p>

<ul>
  <li>在终端中运行: <code class="highlighter-rouge">flutter create -i swift -a kotlin batterylevel</code></li>
</ul>

<h3 id="example-client">Step 2: 创建Flutter平台客户端</h3>

<p>该应用的<code class="highlighter-rouge">State</code>类拥有当前的应用状态。我们需要延长这一点以保持当前的电量</p>

<p>首先，我们构建通道。我们使用<code class="highlighter-rouge">MethodChannel</code>调用一个方法来返回电池电量。</p>

<p>通道的客户端和宿主通过通道构造函数中传递的通道名称进行连接。单个应用中使用的所有通道名称必须是唯一的;
我们建议在通道名称前加一个唯一的“域名前缀”，例如<code class="highlighter-rouge">samples.flutter.io/battery</code>。</p>

<!-- skip -->
<div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="s">'dart:async'</span><span class="o">;</span>

<span class="kn">import</span> <span class="s">'package:flutter/material.dart'</span><span class="o">;</span>
<span class="kn">import</span> <span class="s">'package:flutter/services.dart'</span><span class="o">;</span>
<span class="o">...</span>
<span class="kd">class</span> <span class="nc">_MyHomePageState</span> <span class="kd">extends</span> <span class="n">State</span><span class="o">&lt;</span><span class="n">MyHomePage</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">static</span> <span class="kd">const</span> <span class="n">platform</span> <span class="o">=</span> <span class="kd">const</span> <span class="n">MethodChannel</span><span class="o">(</span><span class="s">'samples.flutter.io/battery'</span><span class="o">);</span>

  <span class="c1">// Get battery level.</span>
<span class="o">}</span>
</code></pre></div></div>

<p>接下来，我们调用通道上的方法，指定通过字符串标识符调用方法<code class="highlighter-rouge">getBatteryLevel</code>。
该调用可能失败 - 例如，如果平台不支持平台API（例如在模拟器中运行时），所以我们将invokeMethod调用包装在try-catch语句中。</p>

<p>我们使用返回的结果，在<code class="highlighter-rouge">setState</code>中来更新用户界面状态<code class="highlighter-rouge">batteryLevel</code>。</p>

<!-- skip -->
<div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// Get battery level.</span>
  <span class="kt">String</span> <span class="n">_batteryLevel</span> <span class="o">=</span> <span class="s">'Unknown battery level.'</span><span class="o">;</span>

  <span class="n">Future</span><span class="o">&lt;</span><span class="n">Null</span><span class="o">&gt;</span> <span class="n">_getBatteryLevel</span><span class="o">()</span> <span class="n">async</span> <span class="o">{</span>
    <span class="kt">String</span> <span class="n">batteryLevel</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="kd">final</span> <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">await</span> <span class="n">platform</span><span class="o">.</span><span class="na">invokeMethod</span><span class="o">(</span><span class="s">'getBatteryLevel'</span><span class="o">);</span>
      <span class="n">batteryLevel</span> <span class="o">=</span> <span class="s">'Battery level at </span><span class="si">$result</span><span class="s"> % .'</span><span class="o">;</span>
    <span class="o">}</span> <span class="n">on</span> <span class="n">PlatformException</span> <span class="k">catch</span> <span class="o">(</span><span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">batteryLevel</span> <span class="o">=</span> <span class="s">"Failed to get battery level: '</span><span class="si">${e.message}</span><span class="s">'."</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">setState</span><span class="o">(()</span> <span class="o">{</span>
      <span class="n">_batteryLevel</span> <span class="o">=</span> <span class="n">batteryLevel</span><span class="o">;</span>
    <span class="o">});</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>最后，我们在build创建包含一个小字体显示电池状态和一个用于刷新值的按钮的用户界面。</p>

<!-- skip -->
<div class="language-dart highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@override</span>
<span class="n">Widget</span> <span class="nf">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">Material</span><span class="o">(</span>
    <span class="nl">child:</span> <span class="k">new</span> <span class="n">Center</span><span class="o">(</span>
      <span class="nl">child:</span> <span class="k">new</span> <span class="n">Column</span><span class="o">(</span>
        <span class="nl">mainAxisAlignment:</span> <span class="n">MainAxisAlignment</span><span class="o">.</span><span class="na">spaceEvenly</span><span class="o">,</span>
        <span class="nl">children:</span> <span class="o">[</span>
          <span class="k">new</span> <span class="n">RaisedButton</span><span class="o">(</span>
            <span class="nl">child:</span> <span class="k">new</span> <span class="n">Text</span><span class="o">(</span><span class="s">'Get Battery Level'</span><span class="o">),</span>
            <span class="nl">onPressed:</span> <span class="n">_getBatteryLevel</span><span class="o">,</span>
          <span class="o">),</span>
          <span class="k">new</span> <span class="n">Text</span><span class="o">(</span><span class="n">_batteryLevel</span><span class="o">),</span>
        <span class="o">],</span>
      <span class="o">),</span>
    <span class="o">),</span>
  <span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="example-java">Step 3a: 使用Java添加Android平台特定的实现</h3>

<p><em>注意</em>: 以下步骤使用Java。如果您更喜欢Kotlin，请跳到步骤3b.</p>

<p>首先在Android Studio中打开您的Flutter应用的Android部分：</p>

<ol>
  <li>
    <p>启动 Android Studio</p>
  </li>
  <li>
    <p>选择 ‘File &gt; Open…’</p>
  </li>
  <li>
    <p>定位到您 Flutter app目录, 然后选择里面的 <code class="highlighter-rouge">android</code>文件夹，点击 OK</p>
  </li>
  <li>
    <p>在<code class="highlighter-rouge">java</code>目录下打开 <code class="highlighter-rouge">MainActivity.java</code></p>
  </li>
</ol>

<p>接下来，在<code class="highlighter-rouge">onCreate</code>里创建MethodChannel并设置一个<code class="highlighter-rouge">MethodCallHandler</code>。确保使用与在Flutter客户端使用的通道名称相同。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">io.flutter.app.FlutterActivity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.flutter.plugin.common.MethodCall</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.flutter.plugin.common.MethodChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.flutter.plugin.common.MethodChannel.MethodCallHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.flutter.plugin.common.MethodChannel.Result</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">FlutterActivity</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CHANNEL</span> <span class="o">=</span> <span class="s">"samples.flutter.io/battery"</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>

        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>

        <span class="k">new</span> <span class="nf">MethodChannel</span><span class="o">(</span><span class="n">getFlutterView</span><span class="o">(),</span> <span class="n">CHANNEL</span><span class="o">).</span><span class="na">setMethodCallHandler</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">MethodCallHandler</span><span class="o">()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMethodCall</span><span class="o">(</span><span class="n">MethodCall</span> <span class="n">call</span><span class="o">,</span> <span class="n">Result</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// TODO</span>
                    <span class="o">}</span>
                <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>接下来，我们添加Java代码，使用Android电池API来获取电池电量。此代码与您在原生Android应用中编写的代码完全相同。</p>

<p>首先，添加需要导入的依赖。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import android.content.ContextWrapper;
import android.content.Intent;
import android.content.IntentFilter;
import android.os.BatteryManager;
import android.os.Build.VERSION;
import android.os.Build.VERSION_CODES;
import android.os.Bundle;
</code></pre></div></div>

<p>然后，将下面的新方法添加到activity类中的，位于onCreate 方法下方：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">int</span> <span class="nf">getBatteryLevel</span><span class="o">()</span> <span class="o">{</span>
  <span class="kt">int</span> <span class="n">batteryLevel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&gt;=</span> <span class="n">VERSION_CODES</span><span class="o">.</span><span class="na">LOLLIPOP</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">BatteryManager</span> <span class="n">batteryManager</span> <span class="o">=</span> <span class="o">(</span><span class="n">BatteryManager</span><span class="o">)</span> <span class="n">getSystemService</span><span class="o">(</span><span class="n">BATTERY_SERVICE</span><span class="o">);</span>
    <span class="n">batteryLevel</span> <span class="o">=</span> <span class="n">batteryManager</span><span class="o">.</span><span class="na">getIntProperty</span><span class="o">(</span><span class="n">BatteryManager</span><span class="o">.</span><span class="na">BATTERY_PROPERTY_CAPACITY</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ContextWrapper</span><span class="o">(</span><span class="n">getApplicationContext</span><span class="o">()).</span>
        <span class="n">registerReceiver</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="n">IntentFilter</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_BATTERY_CHANGED</span><span class="o">));</span>
    <span class="n">batteryLevel</span> <span class="o">=</span> <span class="o">(</span><span class="n">intent</span><span class="o">.</span><span class="na">getIntExtra</span><span class="o">(</span><span class="n">BatteryManager</span><span class="o">.</span><span class="na">EXTRA_LEVEL</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">*</span> <span class="mi">100</span><span class="o">)</span> <span class="o">/</span>
        <span class="n">intent</span><span class="o">.</span><span class="na">getIntExtra</span><span class="o">(</span><span class="n">BatteryManager</span><span class="o">.</span><span class="na">EXTRA_SCALE</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="k">return</span> <span class="n">batteryLevel</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>最后，我们完成之前添加的<code class="highlighter-rouge">onMethodCall</code>方法。我们需要处理平台方法名为<code class="highlighter-rouge">getBatteryLevel</code>，所以我们在call参数中进行检测是否为<code class="highlighter-rouge">getBatteryLevel</code>。
这个平台方法的实现只需调用我们在前一步中编写的Android代码，并使用response参数返回成功和错误情况的响应。如果调用未知的方法，我们也会通知返回：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMethodCall</span><span class="o">(</span><span class="n">MethodCall</span> <span class="n">call</span><span class="o">,</span> <span class="n">Result</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">call</span><span class="o">.</span><span class="na">method</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"getBatteryLevel"</span><span class="o">))</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">batteryLevel</span> <span class="o">=</span> <span class="n">getBatteryLevel</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">batteryLevel</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">batteryLevel</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"UNAVAILABLE"</span><span class="o">,</span> <span class="s">"Battery level not available."</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">result</span><span class="o">.</span><span class="na">notImplemented</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>               
</code></pre></div></div>

<p>您现就可以在Android上运行该应用程序。如果您使用的是Android模拟器，则可以通过工具栏中的<code class="highlighter-rouge">...</code>按钮访问Extended Controls面板中的电池电量</p>

<h3 id="example-kotlin">Step 3b: 使用Kotlin添加Android平台特定的实现</h3>

<p><em>注意</em>: 以下步骤与步骤3a类似，只是使用Kotlin而不是Java。</p>

<p>此步骤假定您在<a href="#example-project">step 1.</a>中 使用该<code class="highlighter-rouge">-a kotlin</code>选项创建了项目</p>

<p>首先在Android Studio中打开您的Flutter应用的Android部分</p>

<ol>
  <li>
    <p>启动 Android Studio</p>
  </li>
  <li>
    <p>选择 the menu item ‘File &gt; Open…’</p>
  </li>
  <li>
    <p>定位到您 Flutter app目录, 然后选择里面的 <code class="highlighter-rouge">android</code>文件夹，点击 OK</p>
  </li>
  <li>
    <p>在<code class="highlighter-rouge">kotlin</code>目录中打开<code class="highlighter-rouge">MainActivity.kt</code>. (注意：如果您使用Android Studio 2.3进行编辑，请注意’kotlin’文件夹将显示为’java’。)</p>
  </li>
</ol>

<p>接下来，在<code class="highlighter-rouge">onCreate</code>里创建MethodChannel并设置一个<code class="highlighter-rouge">MethodCallHandler</code>。确保使用与在Flutter客户端使用的通道名称相同。</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">android.os.Bundle</span>
<span class="k">import</span> <span class="nn">io.flutter.app.FlutterActivity</span>
<span class="k">import</span> <span class="nn">io.flutter.plugin.common.MethodChannel</span>
<span class="k">import</span> <span class="nn">io.flutter.plugins.GeneratedPluginRegistrant</span>

<span class="kd">class</span> <span class="nc">MainActivity</span><span class="p">()</span> <span class="p">:</span> <span class="n">FlutterActivity</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">private</span> <span class="kd">val</span> <span class="py">CHANNEL</span> <span class="p">=</span> <span class="s">"samples.flutter.io/battery"</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
    <span class="n">GeneratedPluginRegistrant</span><span class="p">.</span><span class="n">registerWith</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>

    <span class="n">MethodChannel</span><span class="p">(</span><span class="n">flutterView</span><span class="p">,</span> <span class="n">CHANNEL</span><span class="p">).</span><span class="n">setMethodCallHandler</span> <span class="p">{</span> <span class="n">call</span><span class="p">,</span> <span class="n">result</span> <span class="p">-&gt;</span>
      <span class="c1">// TODO</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>接下来，我们添加Kotlin代码，使用Android电池API来获取电池电量。此代码与您在原生Android应用中编写的代码完全相同。</p>

<p>首先，添加需要导入的依赖。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import android.content.Context
import android.content.ContextWrapper
import android.content.Intent
import android.content.IntentFilter
import android.os.BatteryManager
import android.os.Build.VERSION
import android.os.Build.VERSION_CODES
</code></pre></div></div>

<p>然后，将下面的新方法添加到activity类中的，位于onCreate 方法下方：</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">private</span> <span class="k">fun</span> <span class="n">getBatteryLevel</span><span class="p">():</span> <span class="n">Int</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">batteryLevel</span><span class="p">:</span> <span class="n">Int</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">VERSION</span><span class="p">.</span><span class="n">SDK_INT</span> <span class="p">&gt;=</span> <span class="n">VERSION_CODES</span><span class="p">.</span><span class="n">LOLLIPOP</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">val</span> <span class="py">batteryManager</span> <span class="p">=</span> <span class="n">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="n">BATTERY_SERVICE</span><span class="p">)</span> <span class="k">as</span> <span class="n">BatteryManager</span>
      <span class="n">batteryLevel</span> <span class="p">=</span> <span class="n">batteryManager</span><span class="p">.</span><span class="n">getIntProperty</span><span class="p">(</span><span class="n">BatteryManager</span><span class="p">.</span><span class="n">BATTERY_PROPERTY_CAPACITY</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kd">val</span> <span class="py">intent</span> <span class="p">=</span> <span class="n">ContextWrapper</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">).</span><span class="n">registerReceiver</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="n">IntentFilter</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="n">ACTION_BATTERY_CHANGED</span><span class="p">))</span>
      <span class="n">batteryLevel</span> <span class="p">=</span> <span class="n">intent</span><span class="o">!!</span><span class="p">.</span><span class="n">getIntExtra</span><span class="p">(</span><span class="n">BatteryManager</span><span class="p">.</span><span class="n">EXTRA_LEVEL</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span> <span class="p">*</span> <span class="m">100</span> <span class="p">/</span> <span class="n">intent</span><span class="p">.</span><span class="n">getIntExtra</span><span class="p">(</span><span class="n">BatteryManager</span><span class="p">.</span><span class="n">EXTRA_SCALE</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">batteryLevel</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>最后，我们完成之前添加的<code class="highlighter-rouge">onMethodCall</code>方法。我们需要处理平台方法名为<code class="highlighter-rouge">getBatteryLevel</code>，所以我们在call参数中进行检测是否为<code class="highlighter-rouge">getBatteryLevel</code>。
这个平台方法的实现只需调用我们在前一步中编写的Android代码，并使用response参数返回成功和错误情况的响应。如果调用未知的方法，我们也会通知返回：</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">MethodChannel</span><span class="p">(</span><span class="n">flutterView</span><span class="p">,</span> <span class="n">CHANNEL</span><span class="p">).</span><span class="n">setMethodCallHandler</span> <span class="p">{</span> <span class="n">call</span><span class="p">,</span> <span class="n">result</span> <span class="p">-&gt;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">call</span><span class="p">.</span><span class="n">method</span> <span class="p">==</span> <span class="s">"getBatteryLevel"</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">batteryLevel</span> <span class="p">=</span> <span class="n">getBatteryLevel</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">batteryLevel</span> <span class="p">!=</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">result</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="n">batteryLevel</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">result</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">"UNAVAILABLE"</span><span class="p">,</span> <span class="s">"Battery level not available."</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">result</span><span class="p">.</span><span class="n">notImplemented</span><span class="p">()</span>
      <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>您现就可以在Android上运行该应用程序。如果您使用的是Android模拟器，则可以通过工具栏中的<code class="highlighter-rouge">...</code>按钮访问Extended Controls面板中的电池电量</p>

<h3 id="example-objc">Step 4a: 使用Objective-C添加iOS平台特定的实现</h3>

<p><em>注意</em>: 以下步骤使用Objective-C。如果您喜欢Swift，请跳到步骤4b</p>

<p>首先打开Xcode中Flutter应用程序的iOS部分:</p>

<ol>
  <li>
    <p>启动 Xcode</p>
  </li>
  <li>
    <p>选择 ‘File &gt; Open…’</p>
  </li>
  <li>
    <p>定位到您 Flutter app目录, 然后选择里面的 <code class="highlighter-rouge">iOS</code>文件夹，点击 OK</p>
  </li>
  <li>
    <p>确保Xcode项目的构建没有错误。</p>
  </li>
  <li>
    <p>选择 Runner &gt; Runner ，打开`AppDelegate.m</p>
  </li>
</ol>

<p>接下来，在<code class="highlighter-rouge">application didFinishLaunchingWithOptions:</code>方法内部创建一个<code class="highlighter-rouge">FlutterMethodChannel</code>，并添加一个处理方法。
确保与在Flutter客户端使用的通道名称相同。</p>

<pre><code class="language-objectivec">#import &lt;Flutter/Flutter.h&gt;

@implementation AppDelegate
- (BOOL)application:(UIApplication*)application didFinishLaunchingWithOptions:(NSDictionary*)launchOptions {
  FlutterViewController* controller = (FlutterViewController*)self.window.rootViewController;

  FlutterMethodChannel* batteryChannel = [FlutterMethodChannel
                                          methodChannelWithName:@"samples.flutter.io/battery"
                                          binaryMessenger:controller];

  [batteryChannel setMethodCallHandler:^(FlutterMethodCall* call, FlutterResult result) {
    // TODO
  }];

  return [super application:application didFinishLaunchingWithOptions:launchOptions];
}
</code></pre>

<p>接下来，我们添加ObjectiveC代码，使用iOS电池API来获取电池电量。此代码与您在本机iOS应用程序中编写的代码完全相同。</p>

<p>在<code class="highlighter-rouge">AppDelegate</code>类中添加以下新的方法：</p>

<pre><code class="language-objectivec">- (int)getBatteryLevel {
  UIDevice* device = UIDevice.currentDevice;
  device.batteryMonitoringEnabled = YES;
  if (device.batteryState == UIDeviceBatteryStateUnknown) {
    return -1;
  } else {
    return (int)(device.batteryLevel * 100);
  }
}
</code></pre>

<p>最后，我们完成之前添加的<code class="highlighter-rouge">setMethodCallHandler</code>方法。我们需要处理的平台方法名为<code class="highlighter-rouge">getBatteryLevel</code>，所以我们在call参数中进行检测是否为<code class="highlighter-rouge">getBatteryLevel</code>。
这个平台方法的实现只需调用我们在前一步中编写的IOS代码，并使用response参数返回成功和错误情况的响应。如果调用未知的方法，我们也会通知返回：</p>

<pre><code class="language-objectivec">[batteryChannel setMethodCallHandler:^(FlutterMethodCall* call, FlutterResult result) {
  if ([@"getBatteryLevel" isEqualToString:call.method]) {
    int batteryLevel = [self getBatteryLevel];

    if (batteryLevel == -1) {
      result([FlutterError errorWithCode:@"UNAVAILABLE"
                                 message:@"Battery info unavailable"
                                 details:nil]);
    } else {
      result(@(batteryLevel));
    }
  } else {
    result(FlutterMethodNotImplemented);
  }
}];
</code></pre>

<p>您现在可以在iOS上运行应用程序。如果您使用的是iOS模拟器，请注意，它不支持电池API，因此应用程序将显示“电池信息不可用”。</p>

<h3 id="example-swift">Step 4b: 使用Swift添加一个iOS平台的实现</h3>

<p><em>注意</em>: 以下步骤与步骤4a类似，只不过是使用Swift而不是Objective-C.</p>

<p>此步骤假定您在步骤1中 使用<code class="highlighter-rouge">-i swift</code>选项创建了项目。</p>

<p>首先打开Xcode中Flutter应用程序的iOS部分:</p>

<ol>
  <li>
    <p>启动 Xcode</p>
  </li>
  <li>
    <p>选择 ‘File &gt; Open…’</p>
  </li>
  <li>
    <p>定位到您 Flutter app目录, 然后选择里面的 <code class="highlighter-rouge">ios</code>文件夹，点击 OK</p>
  </li>
  <li>
    <p>确保Xcode项目的构建没有错误。</p>
  </li>
  <li>
    <p>选择 Runner &gt; Runner ，然后打开<code class="highlighter-rouge">AppDelegate.swift</code></p>
  </li>
</ol>

<p>接下来，覆盖application方法并创建一个<code class="highlighter-rouge">FlutterMethodChannel</code>绑定通道名称<code class="highlighter-rouge">samples.flutter.io/battery</code>：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">@UIApplicationMain</span>
<span class="kd">@objc</span> <span class="kd">class</span> <span class="kt">AppDelegate</span><span class="p">:</span> <span class="kt">FlutterAppDelegate</span> <span class="p">{</span>
  <span class="k">override</span> <span class="kd">func</span> <span class="nf">application</span><span class="p">(</span>
    <span class="n">_</span> <span class="nv">application</span><span class="p">:</span> <span class="kt">UIApplication</span><span class="p">,</span>
    <span class="n">didFinishLaunchingWithOptions</span> <span class="nv">launchOptions</span><span class="p">:</span> <span class="p">[</span><span class="kt">UIApplicationLaunchOptionsKey</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]?)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
    <span class="kt">GeneratedPluginRegistrant</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="k">self</span><span class="p">);</span>

    <span class="k">let</span> <span class="nv">controller</span> <span class="p">:</span> <span class="kt">FlutterViewController</span> <span class="o">=</span> <span class="n">window</span><span class="p">?</span><span class="o">.</span><span class="n">rootViewController</span> <span class="k">as!</span> <span class="kt">FlutterViewController</span><span class="p">;</span>
    <span class="k">let</span> <span class="nv">batteryChannel</span> <span class="o">=</span> <span class="kt">FlutterMethodChannel</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"samples.flutter.io/battery"</span><span class="p">,</span>
                                                   <span class="nv">binaryMessenger</span><span class="p">:</span> <span class="n">controller</span><span class="p">);</span>
    <span class="n">batteryChannel</span><span class="o">.</span><span class="nf">setMethodCallHandler</span><span class="p">({</span>
      <span class="p">(</span><span class="nv">call</span><span class="p">:</span> <span class="kt">FlutterMethodCall</span><span class="p">,</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">FlutterResult</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span> <span class="k">in</span>
      <span class="c1">// Handle battery messages.</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="k">super</span><span class="o">.</span><span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="nv">didFinishLaunchingWithOptions</span><span class="p">:</span> <span class="n">launchOptions</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>接下来，我们添加Swift代码，使用iOS电池API来获取电池电量。此代码与您在本机iOS应用程序中编写的代码完全相同。</p>

<p>将以下新方法添加到<code class="highlighter-rouge">AppDelegate.swift</code>底部</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">func</span> <span class="nf">receiveBatteryLevel</span><span class="p">(</span><span class="nv">result</span><span class="p">:</span> <span class="kt">FlutterResult</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">device</span> <span class="o">=</span> <span class="kt">UIDevice</span><span class="o">.</span><span class="n">current</span><span class="p">;</span>
  <span class="n">device</span><span class="o">.</span><span class="n">isBatteryMonitoringEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">batteryState</span> <span class="o">==</span> <span class="kt">UIDeviceBatteryState</span><span class="o">.</span><span class="n">unknown</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">result</span><span class="p">(</span><span class="kt">FlutterError</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">code</span><span class="p">:</span> <span class="s">"UNAVAILABLE"</span><span class="p">,</span>
                             <span class="nv">message</span><span class="p">:</span> <span class="s">"Battery info unavailable"</span><span class="p">,</span>
                             <span class="nv">details</span><span class="p">:</span> <span class="kc">nil</span><span class="p">));</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nf">result</span><span class="p">(</span><span class="kt">Int</span><span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">batteryLevel</span> <span class="o">*</span> <span class="mi">100</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>最后，我们完成之前添加的<code class="highlighter-rouge">setMethodCallHandler</code>方法。我们需要处理的平台方法名为<code class="highlighter-rouge">getBatteryLevel</code>，所以我们在call参数中进行检测是否为<code class="highlighter-rouge">getBatteryLevel</code>。
这个平台方法的实现只需调用我们在前一步中编写的IOS代码，并使用response参数返回成功和错误情况的响应。如果调用未知的方法，我们也会通知返回：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">batteryChannel</span><span class="o">.</span><span class="nf">setMethodCallHandler</span><span class="p">({</span>
  <span class="p">(</span><span class="nv">call</span><span class="p">:</span> <span class="kt">FlutterMethodCall</span><span class="p">,</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">FlutterResult</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span> <span class="k">in</span>
  <span class="k">if</span> <span class="p">(</span><span class="s">"getBatteryLevel"</span> <span class="o">==</span> <span class="n">call</span><span class="o">.</span><span class="n">method</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">receiveBatteryLevel</span><span class="p">(</span><span class="nv">result</span><span class="p">:</span> <span class="n">result</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nf">result</span><span class="p">(</span><span class="kt">FlutterMethodNotImplemented</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<p>您现在可以在iOS上运行应用程序。如果您使用的是iOS模拟器，请注意，它不支持电池API，因此应用程序将显示“电池信息不可用”。</p>

<h2 id="separate">从UI代码中分离平台特定的代码</h2>

<p>如果您希望在多个Flutter应用程序中使用特定于平台的代码，将代码分离为位于主应用程序之外的目录中，做一个平台插件会很有用。详情请参阅<a href="/developing-packages/">开发 packages</a> 。</p>

<h2 id="publish">将平台特定的代码作为一个包发布</h2>

<p>如果您希望与Flutter生态系统中的其他开发人员分享您的特定平台的代码，请参阅发[发布 packages](/developing-packages/#publish以了解详细信息。</p>

<h2 id="自定义平台通道和编解码器">自定义平台通道和编解码器</h2>

<p>除了上面提到的<code class="highlighter-rouge">MethodChannel</code>，你还可以使用<a href="https://docs.flutter.io/flutter/services/BasicMessageChannel-class.html"><code class="highlighter-rouge">BasicMessageChannel</code></a>，它支持使用自定义消息编解码器进行基本的异步消息传递。
此外，您可以使用专门的<a href="https://docs.flutter.io/flutter/services/BinaryCodec-class.html"><code class="highlighter-rouge">BinaryCodec</code></a>，<a href="https://docs.flutter.io/flutter/services/StringCodec-class.html"><code class="highlighter-rouge">StringCodec</code></a>和 <a href="https://docs.flutter.io/flutter/services/JSONMessageCodec-class.html"><code class="highlighter-rouge">JSONMessageCodec</code></a>类，或创建自己的编解码器。</p>


</article>

                    
                      <div style="padding: 20px 0">
                        <h2>留言</h2>
                        <div id="comments"></div>
                      </div>
                    
                </div>

            </div>

            

        </div> <!-- /.row -->
    </div> <!-- /.container -->

    <footer class="site-footer">
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-12">
        <div class="logo">
          <img src= "/images/flutter-mark-square-100.png" width="100" height="100">
        </div>
          <p class="site-footer__link-list hidden-xs">
            <a href="https://groups.google.com/forum/#!forum/flutter-dev">flutter-dev@</a> &bull;
            <a href="https://twitter.com/flutterio">twitter</a> &bull;
            <a href="https://github.com/flutter/">github</a> &bull;
            <a href="/tos">terms</a> &bull;
            <a href="https://www.google.com/intl/en/policies/privacy/">privacy</a>
          </p>
          <p class="footer-links">
            <a href="/about">关于本站</a>
            <a href="/about">加入我们</a>
            <a href="/app/gm.html">Gitme</a>
            <a href="http://www.dartdoc.cn/">Dart中文网</a>
            <a href="/about">Flutter中文网开源计划</a>
            <a href="https://juejin.im/user/58211b88a0bb9f0058c25b7f/posts">译者博客</a>|
            <a href="https://juejin.im/user/58211b88a0bb9f0058c25b7f/posts">Github</a>
          </p>
          <div>
            <a href="http://beian.miit.gov.cn/">京ICP备14014371号-3</a>
          </div>
      </div>
    </div>
  </div>
</footer>


    <!--<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">-->

    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>-->
    <!--<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>-->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"></script>
    <!--<script async="" defer="" src="//survey.g.doubleclick.net/async_survey?site=at3ul57xpub2vk3oxt2ytw365i"></script>-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
    <script src="/js/sidebar_toggle.js"></script>
    <script src="/js/prism.js"></script>
    <script src="/js/tabs.js"></script>
    
      <link rel="stylesheet" href="https://www.flutterchina.club/css/gitment.css">
      <script src="https://www.flutterchina.club/js/comment.js"></script>
    

</body>
</html>
